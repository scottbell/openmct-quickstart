<VirtualHost *:80>
	ServerName localhost

	ServerAdmin localhost
	DocumentRoot /usr/local/apache2/htdocs/openmct/
	AddDefaultCharset utf-8
    AllowEncodedSlashes NoDecode

	DumpIOInput On
	DumpIOOutput On
	LogLevel dumpio:trace7

	<Directory "/usr/local/apache2/htdocs/openmct/">
		AuthType Basic
		AuthName "OpenMCT Quickstart"
		AuthUserFile /usr/local/apache2/conf/.htpasswd
		Require valid-user
	</Directory>

	ErrorLog logs/openmct-error.log
	CustomLog logs/openmct-access.log combined

	RequestHeader set "X-Forwarded-Proto" expr=%{REQUEST_SCHEME}
	ProxyErrorOverride Off

	<Location "/couchdb">
		AuthType Basic
		AuthName "OpenMCT Quickstart"
		AuthUserFile /usr/local/apache2/conf/.htpasswd
		Require valid-user

		RewriteEngine On
		RewriteCond %{REMOTE_USER} ^admin$
		RewriteRule ^ - [E=IS_ADMIN:1]
		RequestHeader set X-Auth-CouchDB-UserName expr=%{REMOTE_USER}
        RequestHeader set X-Auth-CouchDB-Roles "_user"
		RequestHeader set X-Auth-CouchDB-Roles "_admin" env=IS_ADMIN
		
		# Unset the Authorization header before proxying to CouchDB
		RequestHeader unset Authorization

		ProxyPreserveHost On
		ProxyPass http://couchdb:5984 nocanon
		ProxyPassReverse http://couchdb:5984
	</Location>

	<Location "/couchdb/_utils">
		AuthType Basic
		AuthName "OpenMCT Quickstart"
		AuthUserFile /usr/local/apache2/conf/.htpasswd
		Require user admin

		RewriteEngine On
		RewriteCond %{REMOTE_USER} ^admin$
		RewriteRule ^ - [E=IS_ADMIN:1]
		RequestHeader set X-Auth-CouchDB-UserName expr=%{REMOTE_USER}
        RequestHeader set X-Auth-CouchDB-Roles "_user"
		RequestHeader set X-Auth-CouchDB-Roles "_admin" env=IS_ADMIN

		ProxyPreserveHost On
		ProxyPass http://couchdb:5984/_utils nocanon
		ProxyPassReverse http://couchdb:5984/_utils
	</Location>

    <Location "/couchdb2">
		AuthType Basic
		AuthName "OpenMCT Quickstart"
		AuthUserFile /usr/local/apache2/conf/.htpasswd
		Require valid-user

		RewriteEngine On
		RewriteCond %{REMOTE_USER} ^admin$
		RewriteRule ^ - [E=IS_ADMIN:1]
		RequestHeader set X-Auth-CouchDB-UserName expr=%{REMOTE_USER}
        RequestHeader set X-Auth-CouchDB-Roles "_user"
		RequestHeader set X-Auth-CouchDB-Roles "_admin" env=IS_ADMIN
		
		# Unset the Authorization header before proxying to CouchDB
		RequestHeader unset Authorization

		ProxyPreserveHost On
		ProxyPass http://couchdb2:5985 nocanon
		ProxyPassReverse http://couchdb2:5985
	</Location>

	<Location "/couchdb2/_utils">
		AuthType Basic
		AuthName "OpenMCT Quickstart"
		AuthUserFile /usr/local/apache2/conf/.htpasswd
		Require user admin
		ProxyPreserveHost On

		RewriteEngine On
		RewriteCond %{REMOTE_USER} ^admin$
		RewriteRule ^ - [E=IS_ADMIN:1]
		RequestHeader set X-Auth-CouchDB-UserName expr=%{REMOTE_USER}
        RequestHeader set X-Auth-CouchDB-Roles "_user"
		RequestHeader set X-Auth-CouchDB-Roles "_admin" env=IS_ADMIN

		ProxyPass http://couchdb2:5985/_utils nocanon
		ProxyPassReverse http://couchdb2:5985/_utils
	</Location>

	# Restrict /yamcs/admin to the admin user
	<Location "/yamcs/admin">
		AuthType Basic
		AuthName "OpenMCT Quickstart"
		AuthUserFile /usr/local/apache2/conf/.htpasswd
		Require user admin

		RequestHeader set X-REMOTE-USER expr=%{REMOTE_USER}
		ProxyPass "http://yamcs:8090/yamcs/admin"
		ProxyPassReverse "http://yamcs:8090/yamcs/admin"
	</Location>

	# General YAMCS proxy with added X-REMOTE-USER header for entire YAMCS access
	<Location "/yamcs/">
		AuthType Basic
		AuthName "OpenMCT Quickstart"
		AuthUserFile /usr/local/apache2/conf/.htpasswd
		Require valid-user

		RequestHeader set X-REMOTE-USER expr=%{REMOTE_USER}
		ProxyPass "http://yamcs:8090/yamcs/"
		ProxyPassReverse "http://yamcs:8090/yamcs/"
	</Location>


	# YAMCS REST API proxy for Mission Database (MDB)
	<Location "/yamcs/api/mdb/">
		AddOutputFilterByType DEFLATE application/json
		Header append Vary Accept-Encoding
		Header set Cache-Control "public, max-age=300000"
		AuthType Basic
		AuthName "OpenMCT Quickstart"
		AuthUserFile /usr/local/apache2/conf/.htpasswd
		Require valid-user

    	RequestHeader set X-REMOTE-USER expr=%{REMOTE_USER}
		ProxyPass "http://yamcs:8090/yamcs/api/mdb/" nocanon
		ProxyPassReverse "http://yamcs:8090/yamcs/api/mdb/"
	</Location>

	# WebSocket proxy for YAMCS
	ProxyPass "/yamcs/api/websocket" "ws://yamcs:8090/yamcs/api/websocket"
	ProxyPassReverse "/yamcs/api/websocket" "ws://yamcs:8090/yamcs/api/websocket"

	# General YAMCS proxy
	RewriteEngine on
	RewriteCond %{HTTP:Upgrade} websocket [NC]
	RewriteCond %{HTTP:Connection} upgrade [NC]
	RewriteRule /yamcs/(.*) ws://yamcs:8090/yamcs/$1 [P,L]

	RewriteRule ^/yamcs$ /yamcs/ [R]
	ProxyPass "/yamcs/" "http://yamcs:8090/yamcs/"
	ProxyPassReverse "/yamcs/" "http://yamcs:8090/yamcs/"
	
	<Location "/server-status">
		SetHandler server-status
		Require all granted
		AuthType Basic
		AuthName "OpenMCT Quickstart"
		AuthUserFile /usr/local/apache2/conf/.htpasswd
		Require user admin
	</Location>

</VirtualHost>